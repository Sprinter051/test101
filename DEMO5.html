<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมตัดเกรดสำหรับครู</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Windows 98 Theme Styles */
        body {
            background-color: #008080; /* Teal background color */
        }
        
        .win98-container {
            background-color: #C0C0C0;
            border-style: solid;
            border-width: 2px;
            border-color: #FFFFFF #808080 #808080 #FFFFFF;
            padding: 8px;
            box-shadow: 2px 2px 0 0 black;
        }

        .win98-header {
            background-color: #000080;
            color: white;
            padding: 4px 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-style: solid;
            border-width: 2px;
            border-color: #000080 #FFFFFF #FFFFFF #000080;
        }

        .win98-button {
            background-color: #C0C0C0;
            color: black;
            border-style: solid;
            border-width: 2px;
            border-color: #FFFFFF #000000 #000000 #FFFFFF;
            padding: 6px 12px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
        }

        .win98-button:active {
            border-color: #000000 #FFFFFF #FFFFFF #000000;
        }

        .win98-input, .win98-select {
            background-color: #FFFFFF;
            border-style: solid;
            border-width: 2px;
            border-color: #808080 #FFFFFF #FFFFFF #808080;
            padding: 4px;
        }

        /* Custom styles for grade colors - using Win98-like vibrant colors */
        .grade-A { color: #008000; font-weight: bold; } /* Dark Green */
        .grade-B { color: #0000FF; font-weight: bold; } /* Blue */
        .grade-C { color: #800080; font-weight: bold; } /* Purple */
        .grade-D { color: #FF0000; font-weight: bold; } /* Red */
        .grade-F { color: #808080; font-weight: bold; } /* Gray */

        /* Custom Modal Styles (to replace alert/confirm) */
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            display: none;
        }

        .modal-content {
            min-width: 300px;
            padding: 16px;
        }
        
        .editable-score {
            cursor: text;
        }
    </style>
</head>
<body class="bg-gray-300 p-4 sm:p-8 font-sans">

    <!-- Main Container -->
    <div class="max-w-4xl mx-auto win98-container">
        <div class="win98-header">
            <h1 class="text-lg">โปรแกรมคำนวณเกรด</h1>
            <button class="text-sm border-2 border-white px-2 py-0.5 leading-none">_</button>
        </div>

        <!-- Input Section for Weights -->
        <div class="mt-4 win98-container">
            <div class="win98-header">
                <h2 class="text-lg">กำหนดน้ำหนักคะแนน</h2>
                <button class="text-sm border-2 border-white px-2 py-0.5 leading-none">_</button>
            </div>
            <div class="p-4">
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <div class="flex-1">
                        <label for="workWeight" class="block text-black mb-1">น้ำหนักคะแนนเก็บ (Work Weight)</label>
                        <input type="number" id="workWeight" value="60" min="0" max="100" class="w-full win98-input">
                    </div>
                    <div class="flex-1">
                        <label for="examWeight" class="block text-black mb-1">น้ำหนักคะแนนสอบ (Exam Weight)</label>
                        <input type="number" id="examWeight" value="40" min="0" max="100" class="w-full win98-input">
                    </div>
                </div>
                <p id="weightWarning" class="text-sm text-red-700 mt-2 hidden">
                    ⚠️ ผลรวมน้ำหนักคะแนนต้องเท่ากับ 100
                </p>
            </div>
        </div>

        <!-- Input Section for New Student -->
        <div class="mt-4 win98-container">
            <div class="win98-header">
                <h2 class="text-lg">เพิ่มรายชื่อนักเรียน</h2>
                <button class="text-sm border-2 border-white px-2 py-0.5 leading-none">_</button>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 items-end">
                    <div class="sm:col-span-2">
                        <label for="studentName" class="block text-black mb-1">ชื่อ-นามสกุล</label>
                        <input type="text" id="studentName" placeholder="ชื่อนักเรียน" class="w-full win98-input">
                    </div>
                    <div>
                        <label for="workScore" class="block text-black mb-1">คะแนนเก็บ</label>
                        <input type="number" id="workScore" placeholder="0-100" min="0" max="100" class="w-full win98-input">
                    </div>
                    <div>
                        <label for="examScore" class="block text-black mb-1">คะแนนสอบ</label>
                        <input type="number" id="examScore" placeholder="0-100" min="0" max="100" class="w-full win98-input">
                    </div>
                </div>
                <div class="mt-4 flex justify-end">
                    <button id="addStudentBtn" class="win98-button">
                        เพิ่มนักเรียน
                    </button>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-4">
            <button id="calculateGradesBtn" class="w-full win98-button">
                คำนวณเกรดทั้งหมด
            </button>
            <button id="exportCsvBtn" class="w-full win98-button">
                Export Data
            </button>
            <button id="clearDataBtn" class="w-full win98-button">
                ล้างข้อมูลนักเรียนทั้งหมด
            </button>
        </div>

        <!-- Result Table -->
        <div class="table-responsive mt-4 win98-container">
            <div class="win98-header">
                <h2 class="text-lg">ตารางผลลัพธ์</h2>
                <button class="text-sm border-2 border-white px-2 py-0.5 leading-none">_</button>
            </div>
            <table class="min-w-full bg-white">
                <thead>
                    <tr class="bg-gray-400 text-black uppercase text-xs leading-normal">
                        <th class="py-2 px-4 text-left border-2 border-gray-500">#</th>
                        <th class="py-2 px-4 text-left border-2 border-gray-500">ชื่อ-นามสกุล</th>
                        <th class="py-2 px-4 text-center border-2 border-gray-500">คะแนนเก็บ</th>
                        <th class="py-2 px-4 text-center border-2 border-gray-500">คะแนนสอบ</th>
                        <th class="py-2 px-4 text-center border-2 border-gray-500">คะแนนรวม</th>
                        <th class="py-2 px-4 text-center border-2 border-gray-500">เกรด</th>
                        <th class="py-2 px-4 text-center border-2 border-gray-500">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody" class="text-black text-sm font-light">
                    <!-- Student rows will be injected here by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Footer -->
        <div class="text-center mt-4 text-black text-xs">
            <p>© 2024 Grade Calculator</p>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlert" class="modal win98-container">
        <div class="win98-header">
            <span class="text-lg">Message</span>
            <button class="text-sm border-2 border-white px-2 py-0.5 leading-none" onclick="document.getElementById('customAlert').style.display='none'">X</button>
        </div>
        <div class="modal-content">
            <p id="alertMessage" class="mb-4 text-black"></p>
            <button class="win98-button block mx-auto" onclick="document.getElementById('customAlert').style.display='none'">OK</button>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="customConfirm" class="modal win98-container">
        <div class="win98-header">
            <span class="text-lg">Confirm</span>
            <button class="text-sm border-2 border-white px-2 py-0.5 leading-none" onclick="document.getElementById('customConfirm').style.display='none'">X</button>
        </div>
        <div class="modal-content">
            <p id="confirmMessage" class="mb-4 text-black"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirmOkBtn" class="win98-button">OK</button>
                <button id="confirmCancelBtn" class="win98-button">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // JavaScript เริ่มต้น
        document.addEventListener('DOMContentLoaded', () => {

            // === ตัวแปร DOM elements ===
            const studentNameInput = document.getElementById('studentName');
            const workScoreInput = document.getElementById('workScore');
            const examScoreInput = document.getElementById('examScore');
            const addStudentBtn = document.getElementById('addStudentBtn');
            const calculateGradesBtn = document.getElementById('calculateGradesBtn');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const clearDataBtn = document.getElementById('clearDataBtn');
            const studentTableBody = document.getElementById('studentTableBody');
            const workWeightInput = document.getElementById('workWeight');
            const examWeightInput = document.getElementById('examWeight');
            const weightWarning = document.getElementById('weightWarning');

            // Custom modal elements
            const customAlert = document.getElementById('customAlert');
            const alertMessage = document.getElementById('alertMessage');
            const customConfirm = document.getElementById('customConfirm');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmOkBtn = document.getElementById('confirmOkBtn');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');

            // Function to show custom alert modal
            function showAlert(message) {
                alertMessage.textContent = message;
                customAlert.style.display = 'block';
            }

            // Function to show custom confirm modal
            function showConfirm(message, callback) {
                confirmMessage.textContent = message;
                customConfirm.style.display = 'block';

                confirmOkBtn.onclick = () => {
                    callback();
                    customConfirm.style.display = 'none';
                };

                confirmCancelBtn.onclick = () => {
                    customConfirm.style.display = 'none';
                };
            }

            // === ฟังก์ชันจัดการข้อมูลนักเรียน ===
            let students = [];

            // โหลดข้อมูลนักเรียนจาก Local Storage
            function loadStudents() {
                const storedStudents = localStorage.getItem('students');
                if (storedStudents) {
                    students = JSON.parse(storedStudents);
                } else {
                    // ตัวอย่างข้อมูล 5 คน ถ้ายังไม่มีข้อมูลใน localStorage
                    students = [
                        { name: "อาทิตย์ ไชยพร", workScore: 82, examScore: 88, totalScore: 0, grade: "" },
                        { name: "เบญจมาศ ศรีวัน", workScore: 76, examScore: 91, totalScore: 0, grade: "" },
                        { name: "ชานันท์ เล็กดี", workScore: 95, examScore: 85, totalScore: 0, grade: "" },
                        { name: "ดวงใจ พิสิฐ", workScore: 68, examScore: 72, totalScore: 0, grade: "" },
                        { name: "เอกชัย ยอดศรี", workScore: 54, examScore: 63, totalScore: 0, grade: "" }
                    ];
                    saveStudents();
                }
                renderTable(); // แสดงผลตารางทันทีหลังโหลด
            }

            // บันทึกข้อมูลนักเรียนลง Local Storage
            function saveStudents() {
                localStorage.setItem('students', JSON.stringify(students));
            }
            
            // ตรวจสอบความถูกต้องของน้ำหนักคะแนน
            function validateWeights() {
                const workWeight = parseFloat(workWeightInput.value) || 0;
                const examWeight = parseFloat(examWeightInput.value) || 0;
                if (workWeight + examWeight !== 100) {
                    weightWarning.classList.remove('hidden');
                    return false;
                } else {
                    weightWarning.classList.add('hidden');
                    return true;
                }
            }

            // คำนวณคะแนนรวมและเกรด
            function calculateGrades() {
                if (!validateWeights()) return;
                
                const workWeight = parseFloat(workWeightInput.value) / 100;
                const examWeight = parseFloat(examWeightInput.value) / 100;

                students.forEach(student => {
                    const total = (student.workScore * workWeight) + (student.examScore * examWeight);
                    student.totalScore = total.toFixed(2);
                    student.grade = getGrade(total);
                });
                renderTable();
                saveStudents();
            }

            // กำหนดเกรดตามคะแนนรวม
            function getGrade(score) {
                if (score >= 80) return "A";
                if (score >= 70) return "B";
                if (score >= 60) return "C";
                if (score >= 50) return "D";
                return "F";
            }

            // แสดงผลข้อมูลในตาราง
            function renderTable() {
                studentTableBody.innerHTML = '';
                students.forEach((student, index) => {
                    const gradeClass = `grade-${student.grade}`;
                    const row = `
                        <tr class="border-b border-gray-200">
                            <td class="py-3 px-6 text-left whitespace-nowrap">${index + 1}</td>
                            <td class="py-3 px-6 text-left">${student.name}</td>
                            <td class="py-3 px-6 text-center editable-score" data-index="${index}" data-field="workScore" contenteditable="true">${student.workScore}</td>
                            <td class="py-3 px-6 text-center editable-score" data-index="${index}" data-field="examScore" contenteditable="true">${student.examScore}</td>
                            <td class="py-3 px-6 text-center font-semibold">${student.totalScore}</td>
                            <td class="py-3 px-6 text-center font-bold text-lg ${gradeClass}">${student.grade}</td>
                            <td class="py-3 px-6 text-center">
                                <button onclick="deleteStudent(${index})" class="win98-button text-xs py-1 px-2 leading-none">
                                    ลบ
                                </button>
                            </td>
                        </tr>
                    `;
                    studentTableBody.innerHTML += row;
                });
            }

            // ลบนักเรียน
            window.deleteStudent = function(index) {
                showConfirm("คุณแน่ใจหรือไม่ที่จะลบข้อมูลนักเรียนคนนี้?", () => {
                    students.splice(index, 1);
                    saveStudents();
                    renderTable();
                });
            }

            // Export CSV
            function exportCsv() {
                const csvRows = [];
                const headers = ["#", "ชื่อ-นามสกุล", "คะแนนเก็บ", "คะแนนสอบ", "คะแนนรวม", "เกรด"];
                csvRows.push(headers.join(","));

                students.forEach((student, index) => {
                    const row = [
                        index + 1,
                        `"${student.name.replace(/"/g, '""')}"`, // escape double quotes
                        student.workScore,
                        student.examScore,
                        student.totalScore,
                        student.grade
                    ];
                    csvRows.push(row.join(","));
                });

                const csvString = csvRows.join("\n");
                const blob = new Blob([`\ufeff${csvString}`], { type: 'text/csv;charset=utf-8;' }); // Add BOM for Thai characters
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'grade_report.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
            
            // === Event Listeners ===
            addStudentBtn.addEventListener('click', () => {
                const name = studentNameInput.value.trim();
                const workScore = parseFloat(workScoreInput.value);
                const examScore = parseFloat(examScoreInput.value);

                // ตรวจสอบข้อมูลก่อนเพิ่ม
                if (name === "" || isNaN(workScore) || isNaN(examScore) || workScore < 0 || workScore > 100 || examScore < 0 || examScore > 100) {
                    showAlert("กรุณาป้อนข้อมูลให้ครบถ้วนและถูกต้อง (คะแนน 0-100)");
                    return;
                }

                const newStudent = {
                    name: name,
                    workScore: workScore,
                    examScore: examScore,
                    totalScore: 0,
                    grade: ""
                };
                
                students.push(newStudent);
                saveStudents();
                renderTable();

                // ล้างฟอร์ม
                studentNameInput.value = '';
                workScoreInput.value = '';
                examScoreInput.value = '';
                studentNameInput.focus();
            });

            calculateGradesBtn.addEventListener('click', calculateGrades);
            exportCsvBtn.addEventListener('click', exportCsv);
            
            clearDataBtn.addEventListener('click', () => {
                showConfirm("คุณแน่ใจหรือไม่ที่จะลบข้อมูลนักเรียนทั้งหมด?", () => {
                    localStorage.removeItem('students');
                    students = [];
                    renderTable();
                });
            });

            // ตรวจสอบน้ำหนักคะแนนเมื่อมีการเปลี่ยนแปลง
            workWeightInput.addEventListener('input', validateWeights);
            examWeightInput.addEventListener('input', validateWeights);

            // === Event listener สำหรับการแก้ไขคะแนนในตาราง ===
            studentTableBody.addEventListener('input', (event) => {
                const target = event.target;
                // ตรวจสอบว่าเป็นช่องคะแนนที่แก้ไขได้หรือไม่
                if (target.classList.contains('editable-score')) {
                    const index = target.getAttribute('data-index');
                    const field = target.getAttribute('data-field');
                    let score = parseFloat(target.textContent);

                    // ตรวจสอบความถูกต้องของคะแนน
                    if (isNaN(score) || score < 0 || score > 100) {
                        showAlert("กรุณาป้อนตัวเลขคะแนนที่ถูกต้อง (0-100)");
                        target.textContent = students[index][field]; // คืนค่าเดิม
                    } else {
                        students[index][field] = score; // อัปเดตข้อมูลใน array
                        calculateGrades(); // คำนวณเกรดใหม่
                    }
                }
            });

            // โหลดข้อมูลเมื่อหน้าเว็บเปิดครั้งแรก
            loadStudents();
            calculateGrades();
        });
    </script>
</body>
</html>
